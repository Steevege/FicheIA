<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2980b9">
  <title>FicheIA</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <div id="app">

    <!-- ÉCRAN ACCUEIL -->
    <div id="screen-home" class="screen active">
      <header class="app-header">
        <h1 class="app-title">FicheIA</h1>
        <button id="btn-settings" class="btn-icon" aria-label="Paramètres">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </header>
      <main class="home-content">
        <button id="btn-new-fiche" class="btn-primary btn-large">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
          Nouvelle fiche
        </button>
        <button id="btn-history" class="btn-secondary btn-large">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 16l4-8 4 4 4-6"/></svg>
          <span>Mes fiches <span id="history-count"></span></span>
        </button>
        <div id="api-status" class="api-status"></div>
      </main>
    </div>

    <!-- ÉCRAN IMPORT PHOTOS -->
    <div id="screen-import" class="screen">
      <header class="app-header">
        <button class="btn-back" data-target="home">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <h2 class="header-title">Import photos</h2>
        <div class="header-spacer"></div>
      </header>
      <main class="import-content">
        <div id="photo-grid" class="photo-grid"></div>
        <div class="import-actions">
          <button id="btn-add-camera" class="btn-add" aria-label="Prendre une photo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
            Photo
          </button>
          <button id="btn-add-gallery" class="btn-add" aria-label="Choisir depuis la galerie">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
            Galerie
          </button>
        </div>
        <input type="file" id="input-camera" accept="image/*" capture="environment" hidden>
        <input type="file" id="input-gallery" accept="image/*" multiple hidden>
        <p id="photo-count" class="photo-count"></p>
        <button id="btn-to-config" class="btn-primary btn-large" disabled>
          Configurer
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
      </main>
    </div>

    <!-- ÉCRAN CONFIGURATION -->
    <div id="screen-config" class="screen">
      <header class="app-header">
        <button class="btn-back" data-target="import">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <h2 class="header-title">Configuration</h2>
        <div class="header-spacer"></div>
      </header>
      <main class="config-content">
        <div id="config-loading" class="config-loading">
          <div class="spinner"></div>
          <p>Analyse en cours...</p>
        </div>
        <div id="config-form" class="config-form" hidden>
          <label class="form-label">Matière détectée :</label>
          <select id="select-subject" class="form-select">
            <option value="Physique-Chimie">Physique-Chimie</option>
            <option value="Mathématiques">Mathématiques</option>
            <option value="SVT">SVT / Biologie</option>
            <option value="Histoire-Géo">Histoire-Géo</option>
            <option value="Français">Français / Lettres</option>
            <option value="Philosophie">Philosophie</option>
            <option value="Langues">Langues</option>
            <option value="Économie">Économie / SES</option>
            <option value="Autre">Autre</option>
          </select>

          <label class="form-label">Niveau :</label>
          <div id="level-picker" class="pill-picker">
            <button class="pill active" data-value="seconde">Seconde</button>
            <button class="pill" data-value="premiere">Première</button>
            <button class="pill" data-value="terminale">Terminale</button>
          </div>

          <label class="form-label">Type de fiche :</label>
          <div id="type-picker" class="pill-picker">
            <button class="pill active" data-value="revision">Révision</button>
            <button class="pill" data-value="resume">Résumé</button>
            <button class="pill" data-value="flashcards">Flashcards</button>
            <button class="pill" data-value="methode">Méthode</button>
          </div>

          <label class="form-label">Densité :</label>
          <div id="density-picker" class="pill-picker">
            <button class="pill" data-value="compact">Compact</button>
            <button class="pill active" data-value="normal">Normal</button>
            <button class="pill" data-value="detaille">Détaillé</button>
          </div>

          <label class="form-label">Thème couleur :</label>
          <div id="color-picker" class="color-picker">
            <button class="color-dot active" data-main="#2980b9" data-accent="#e67e22" style="background:#2980b9" aria-label="Bleu"></button>
            <button class="color-dot" data-main="#8e44ad" data-accent="#e74c3c" style="background:#8e44ad" aria-label="Violet"></button>
            <button class="color-dot" data-main="#27ae60" data-accent="#f39c12" style="background:#27ae60" aria-label="Vert"></button>
            <button class="color-dot" data-main="#c0392b" data-accent="#16a085" style="background:#c0392b" aria-label="Rouge"></button>
            <button class="color-dot" data-main="#f39c12" data-accent="#2980b9" style="background:#f39c12" aria-label="Orange"></button>
          </div>

          <label class="form-label">Taille de police : <span id="font-size-value">14</span>px</label>
          <input type="range" id="slider-fontsize" class="form-slider" min="10" max="22" value="14" step="1">

          <div class="toggle-row">
            <label class="form-label">Ajouter une synthèse</label>
            <label class="toggle">
              <input type="checkbox" id="toggle-synthesis">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <button id="btn-generate" class="btn-primary btn-large btn-generate">
            Générer la fiche
          </button>
        </div>
      </main>
    </div>

    <!-- ÉCRAN VIEWER -->
    <div id="screen-viewer" class="screen">
      <header class="app-header">
        <button class="btn-back" data-target="home">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <h2 id="viewer-title" class="header-title">Fiche</h2>
        <div class="header-spacer"></div>
      </header>
      <main class="viewer-content">
        <div class="viewer-toolbar">
          <label class="toolbar-label">Taille :</label>
          <input type="range" id="slider-viewer-fontsize" class="form-slider toolbar-slider" min="10" max="22" value="14" step="1">
          <span id="viewer-fontsize-value" class="toolbar-value">14px</span>
        </div>
        <div id="generation-progress" class="generation-progress" hidden>
          <div class="spinner"></div>
          <p id="generation-message">Analyse des photos...</p>
        </div>
        <div id="fiche-container" class="fiche-container" hidden>
          <iframe id="fiche-iframe" class="fiche-iframe" sandbox="allow-same-origin"></iframe>
        </div>
        <div class="viewer-actions">
          <button id="btn-pdf" class="btn-action" title="Exporter PDF">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            PDF
          </button>
          <button id="btn-print" class="btn-action" title="Imprimer">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Imprimer
          </button>
          <button id="btn-save" class="btn-action" title="Sauvegarder">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Sauver
          </button>
          <button id="btn-edit" class="btn-action" title="Modifier le HTML">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Modifier
          </button>
          <button id="btn-regenerate" class="btn-action" title="Régénérer la fiche">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
            Refaire
          </button>
          <button id="btn-share" class="btn-action" title="Copier le HTML">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
            Partager
          </button>
        </div>
      </main>
      <!-- Éditeur HTML (caché par défaut) -->
      <div id="editor-overlay" class="editor-overlay" hidden>
        <div class="editor-header">
          <h3>Modifier le HTML</h3>
          <button id="btn-close-editor" class="btn-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <textarea id="html-editor" class="html-editor"></textarea>
        <button id="btn-apply-edit" class="btn-primary">Appliquer les modifications</button>
      </div>
    </div>

    <!-- ÉCRAN HISTORIQUE -->
    <div id="screen-history" class="screen">
      <header class="app-header">
        <button class="btn-back" data-target="home">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <h2 class="header-title">Mes fiches</h2>
        <div class="header-spacer"></div>
      </header>
      <main class="history-content">
        <div id="history-list" class="history-list"></div>
        <p id="history-empty" class="history-empty" hidden>Aucune fiche sauvegardée</p>
      </main>
    </div>

    <!-- MODAL PARAMÈTRES -->
    <div id="modal-settings" class="modal" hidden>
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Paramètres</h3>
          <button id="btn-close-settings" class="btn-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <label class="form-label" for="input-api-key">Clé API Anthropic :</label>
          <div class="api-key-row">
            <input type="password" id="input-api-key" class="form-input" placeholder="sk-ant-api03-...">
            <button id="btn-toggle-key" class="btn-icon" aria-label="Afficher/masquer la clé">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <div class="settings-actions">
            <button id="btn-test-api" class="btn-secondary">Tester</button>
            <button id="btn-save-api" class="btn-primary">Sauvegarder</button>
          </div>
          <p id="api-test-result" class="api-test-result"></p>

          <hr class="settings-divider">

          <label class="form-label">Police par défaut : <span id="settings-fontsize-value">14</span>px</label>
          <input type="range" id="slider-settings-fontsize" class="form-slider" min="10" max="22" value="14" step="1">

          <label class="form-label" for="select-default-subject">Matière par défaut :</label>
          <select id="select-default-subject" class="form-select">
            <option value="">Auto-détection</option>
            <option value="Physique-Chimie">Physique-Chimie</option>
            <option value="Mathématiques">Mathématiques</option>
            <option value="SVT">SVT / Biologie</option>
            <option value="Histoire-Géo">Histoire-Géo</option>
            <option value="Français">Français / Lettres</option>
            <option value="Philosophie">Philosophie</option>
            <option value="Langues">Langues</option>
            <option value="Économie">Économie / SES</option>
            <option value="Autre">Autre</option>
          </select>

          <label class="form-label">Modèle IA :</label>
          <div id="model-picker" class="pill-picker">
            <button class="pill active" data-value="sonnet">Sonnet 4.6 (qualité)</button>
            <button class="pill" data-value="haiku">Haiku 4.5 (rapide)</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="js/history.js"></script>
  <script src="js/api.js"></script>
  <script src="js/generator.js"></script>
  <script src="js/pdf.js"></script>
  <script src="js/app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
